name: Fix Dashboard - Restore v4.26.0
on: [push, workflow_dispatch]
permissions:
  contents: write
jobs:
  fix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 10
      - name: Restore from pre-broken commit
        run: |
          git show 9853b7a:src/routes/dashboardRoutes.js > /tmp/base.js
          echo "Base file restored: $(wc -c < /tmp/base.js) bytes"
      - name: Apply v4.26.0 patches
        run: |
          cp /tmp/base.js src/routes/dashboardRoutes.js
          sed -i '1,5 s/QUANTUM Dashboard v4.24.2 - Smart URL Fallback Fix/QUANTUM Dashboard v4.26.0 - Lead Management Tab/' src/routes/dashboardRoutes.js
          sed -i 's/var D=null,LD=null,currentTab/var D=null,LD=null,LEADS=null,currentTab/' src/routes/dashboardRoutes.js
          sed -i "s/QUANTUM v4.24.2/QUANTUM v4.26.0/" src/routes/dashboardRoutes.js
          echo "Basic patches applied"
      - name: Insert Lead CSS and Functions
        run: |
          python3 << 'PYEOF'
          import re
          with open('src/routes/dashboardRoutes.js', 'r') as f:
              content = f.read()

          lead_css = """.lead-card{background:#0f1623;border:1px solid #1a2744;border-radius:12px;padding:16px;margin-bottom:10px;transition:border-color .2s;cursor:pointer}
          .lead-card:hover{border-color:#243352}
          .lead-card.urgent{border-right:3px solid #ff4d6a}
          .lead-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
          .lead-name{font-size:15px;font-weight:700;color:#e2e8f0}
          .lead-type{font-size:10px;font-weight:700;padding:3px 8px;border-radius:4px;letter-spacing:1px}
          .lead-type.investor{background:rgba(6,214,160,.12);color:#06d6a0}
          .lead-type.owner{background:rgba(59,130,246,.12);color:#3b82f6}
          .lead-badge-urgent{font-size:9px;font-weight:800;padding:2px 6px;border-radius:3px;background:rgba(255,77,106,.15);color:#ff4d6a;margin-right:6px}
          .lead-meta{display:flex;flex-wrap:wrap;gap:10px;font-size:12px;color:#8899b4;margin-bottom:8px}
          .lead-meta span{display:flex;align-items:center;gap:3px}
          .lead-details{font-size:12px;color:#6b7fa3;line-height:1.6}
          .lead-actions{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
          .lead-status-btn{padding:4px 10px;font-size:10px;font-weight:700;border-radius:5px;border:1px solid #243352;background:transparent;color:#8899b4;cursor:pointer;font-family:inherit;transition:all .15s}
          .lead-status-btn:hover{border-color:#4a5e80;color:#e2e8f0}
          .lead-status-btn.active-new{background:rgba(6,214,160,.12);color:#06d6a0;border-color:rgba(6,214,160,.3)}
          .lead-status-btn.active-contacted{background:rgba(59,130,246,.12);color:#3b82f6;border-color:rgba(59,130,246,.3)}
          .lead-status-btn.active-qualified{background:rgba(255,194,51,.12);color:#ffc233;border-color:rgba(255,194,51,.3)}
          .lead-status-btn.active-negotiation{background:rgba(159,122,234,.12);color:#9f7aea;border-color:rgba(159,122,234,.3)}
          .lead-status-btn.active-closed{background:rgba(6,214,160,.2);color:#06d6a0;border-color:rgba(6,214,160,.4)}
          .lead-status-btn.active-lost{background:rgba(255,77,106,.1);color:#ff4d6a;border-color:rgba(255,77,106,.2)}
          .lead-filters{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px;align-items:center}
          .lead-filter-btn{padding:5px 12px;font-size:11px;font-weight:600;border-radius:6px;border:1px solid #243352;background:transparent;color:#8899b4;cursor:pointer;font-family:inherit;transition:all .15s}
          .lead-filter-btn:hover{border-color:#4a5e80}
          .lead-filter-btn.active{background:rgba(6,214,160,.12);color:#06d6a0;border-color:rgba(6,214,160,.3)}
          .lead-stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:10px;margin-bottom:16px}
          .lead-stat{background:#141d2e;border:1px solid #1a2744;border-radius:8px;padding:12px;text-align:center}
          .lead-stat .val{font-size:22px;font-weight:800;color:#06d6a0;font-family:DM Serif Display,serif}
          .lead-stat .lbl{font-size:10px;color:#4a5e80;margin-top:2px}
          .lead-empty{color:#4a5e80;text-align:center;padding:40px;font-size:14px}
          .lead-contact-links{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
          .lead-contact-links a{padding:3px 10px;border-radius:5px;font-size:10px;font-weight:600;cursor:pointer;border:1px solid rgba(96,165,250,.25);background:rgba(96,165,250,.06);color:#60a5fa;text-decoration:none;white-space:nowrap}
          .lead-contact-links a:hover{background:rgba(96,165,250,.15)}"""

          content = content.replace('</style>', lead_css + '\n</style>')

          # Add leads tab
          content = content.replace(
              "{id:'alerts',l:'\\u05D4\\u05EA\\u05E8\\u05D0\\u05D5\\u05EA'}\n];",
              "{id:'alerts',l:'\\u05D4\\u05EA\\u05E8\\u05D0\\u05D5\\u05EA'},\n  {id:'leads',l:'\\u05DC\\u05D9\\u05D3\\u05D9\\u05DD'}\n];"
          )

          # Add leads badge
          old_badge = "if(tabs[i].id==='alerts'&&D&&D.recentAlerts)cnt='<span class=\"cnt-badge\">'+D.recentAlerts.length+'</span>';"
          content = content.replace(old_badge, old_badge + "\n    if(tabs[i].id==='leads'&&LEADS&&LEADS.stats)cnt='<span class=\"cnt-badge\">'+LEADS.stats.total+'</span>';")

          # Update switchTab
          content = content.replace(
              "function switchTab(id){currentTab=id;if(id==='listings'&&!LD)loadListings();renderNav();renderTab();}",
              "function switchTab(id){currentTab=id;if(id==='listings'&&!LD)loadListings();if(id==='leads'&&!LEADS)loadLeads();renderNav();renderTab();}"
          )

          # Update renderTab
          old_rt = "else if(currentTab==='alerts')m.innerHTML=renderAlerts(alerts);"
          content = content.replace(old_rt, old_rt + "\n  else if(currentTab==='leads')m.innerHTML=renderLeads();")

          # Add loadLeads after loadListings
          load_end = "}).catch(function(e){console.error(e);});\n}"
          leads_funcs = """}).catch(function(e){console.error(e);});
          }
          function loadLeads(){
            Promise.all([
              fetch('/api/leads?limit=100').then(function(r){return r.json();}),
              fetch('/api/leads/stats').then(function(r){return r.json();})
            ]).then(function(results){
              LEADS={leads:results[0].leads||[],stats:results[1]};renderNav();renderTab();
            }).catch(function(e){console.error('Leads load error:',e);});
          }
          function updateLeadStatus(id,status){
            fetch('/api/leads/'+id+'/status',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:status})})
            .then(function(r){return r.json();}).then(function(){loadLeads();})
            .catch(function(e){console.error(e);});
          }"""
          idx = content.find(load_end)
          if idx > 0:
              content = content[:idx] + leads_funcs + content[idx+len(load_end):]

          with open('src/routes/dashboardRoutes.js', 'w') as f:
              f.write(content)
          print(f"Phase 1 done: {len(content)} bytes")
          PYEOF
      - name: Insert renderLeads function
        run: |
          python3 << 'PYEOF'
          with open('src/routes/dashboardRoutes.js', 'r') as f:
              content = f.read()

          render_leads = """
          // ==================== LEADS ====================
          function renderLeads(){
            if(!LEADS)return'<div class="tab-content"><div class="lead-empty">\\u05D8\\u05D5\\u05E2\\u05DF \\u05DC\\u05D9\\u05D3\\u05D9\\u05DD...</div></div>';
            var leads=LEADS.leads||[],st=LEADS.stats||{};
            var typeFilter=(filterStates.leads||{}).type||'all';
            var statusFilter=(filterStates.leads||{}).status||'all';
            var filtered=leads.filter(function(l){
              if(typeFilter!=='all'&&l.user_type!==typeFilter)return false;
              if(statusFilter!=='all'&&l.status!==statusFilter)return false;
              return true;
            });
            var h='<div class="tab-content">';
            h+='<div class="lead-stats-row">';
            h+='<div class="lead-stat"><div class="val">'+(st.total||0)+'</div><div class="lbl">\\u05E1\\u05D4\\"\\u05DB</div></div>';
            h+='<div class="lead-stat"><div class="val" style="color:#06d6a0">'+(st.investors||0)+'</div><div class="lbl">\\u05DE\\u05E9\\u05E7\\u05D9\\u05E2\\u05D9\\u05DD</div></div>';
            h+='<div class="lead-stat"><div class="val" style="color:#3b82f6">'+(st.sellers||0)+'</div><div class="lbl">\\u05DE\\u05D5\\u05DB\\u05E8\\u05D9\\u05DD</div></div>';
            h+='<div class="lead-stat"><div class="val" style="color:#ff4d6a">'+(st.urgent||0)+'</div><div class="lbl">\\u05D3\\u05D7\\u05D5\\u05E4\\u05D9\\u05DD</div></div>';
            h+='<div class="lead-stat"><div class="val" style="color:#ffc233">'+(st.new_count||0)+'</div><div class="lbl">\\u05D7\\u05D3\\u05E9\\u05D9\\u05DD</div></div>';
            h+='</div>';
            h+='<div class="lead-filters">';
            h+='<button class="lead-filter-btn'+(typeFilter==='all'?' active':'')+'\" data-lead-type="all">\\u05DB\\u05DC</button>';
            h+='<button class="lead-filter-btn'+(typeFilter==='investor'?' active':'')+'\" data-lead-type="investor">\\u05DE\\u05E9\\u05E7\\u05D9\\u05E2\\u05D9\\u05DD</button>';
            h+='<button class="lead-filter-btn'+(typeFilter==='owner'?' active':'')+'\" data-lead-type="owner">\\u05DE\\u05D5\\u05DB\\u05E8\\u05D9\\u05DD</button>';
            h+='<span style="width:1px;height:20px;background:#243352;margin:0 4px"></span>';
            var statusBtns=[['all','\\u05DB\\u05DC \\u05D4\\u05E1\\u05D8\\u05D8\\u05D5\\u05E1\\u05D9\\u05DD'],['new','\\u05D7\\u05D3\\u05E9'],['contacted','\\u05E0\\u05D9\\u05E6\\u05E8 \\u05E7\\u05E9\\u05E8'],['qualified','\\u05DE\\u05EA\\u05D0\\u05D9\\u05DD'],['negotiation','\\u05DE\\u05D5\\"\\u05DE'],['closed','\\u05E0\\u05E1\\u05D2\\u05E8']];
            for(var s=0;s<statusBtns.length;s++){h+='<button class="lead-filter-btn'+(statusFilter===statusBtns[s][0]?' active':'')+'\" data-lead-status="'+statusBtns[s][0]+'">'+statusBtns[s][1]+'</button>';}
            h+='<button class="btn" data-action="refresh-leads" style="margin-right:auto;font-size:10px">\\u21BB \\u05E8\\u05E2\\u05E0\\u05DF</button>';
            h+='</div>';
            if(filtered.length===0){h+='<div class="lead-empty">\\u05D0\\u05D9\\u05DF \\u05DC\\u05D9\\u05D3\\u05D9\\u05DD \\u05DC\\u05D4\\u05E6\\u05D9\\u05D2</div>';}
            else{for(var i=0;i<filtered.length;i++){
              var l=filtered[i],fd=l.form_data||{};
              h+='<div class="lead-card'+(l.is_urgent?' urgent':'')+'\" data-lead-id="'+l.id+'">';
              h+='<div class="lead-head"><div><span class="lead-name">'+esc(l.name||'\\u05DC\\u05DC\\u05D0 \\u05E9\\u05DD')+'</span>';
              if(l.is_urgent)h+=' <span class="lead-badge-urgent">URGENT</span>';
              h+='</div><span class="lead-type '+(l.user_type||'')+'">'+(l.user_type==='investor'?'\\u05DE\\u05E9\\u05E7\\u05D9\\u05E2':'\\u05DE\\u05D5\\u05DB\\u05E8')+'</span></div>';
              h+='<div class="lead-meta">';
              if(l.phone)h+='<span>\\u260E '+esc(l.phone)+'</span>';
              if(l.email)h+='<span>\\u2709 '+esc(l.email)+'</span>';
              h+='<span class="lead-time">'+formatLeadDate(l.created_at)+'</span></div>';
              h+='<div class="lead-details">';
              if(l.user_type==='investor'){
                if(fd.budget)h+='\\u05EA\\u05E7\\u05E6\\u05D9\\u05D1: '+esc(formatBudget(fd.budget))+' | ';
                if(fd.areas&&fd.areas.length)h+='\\u05D0\\u05D6\\u05D5\\u05E8\\u05D9\\u05DD: '+fd.areas.map(esc).join(', ')+' | ';
              }else{
                if(fd.addresses&&fd.addresses.length)h+='\\u05DB\\u05EA\\u05D5\\u05D1\\u05D5\\u05EA: '+fd.addresses.map(function(a){return esc(a.street||'')+' '+esc(a.city||'');}).join('; ')+' | ';
                if(fd.propertyType)h+='\\u05E1\\u05D5\\u05D2: '+esc(fd.propertyType)+' | ';
              }
              h+='</div>';
              h+='<div class="lead-contact-links">';
              if(l.phone)h+='<a href="tel:'+esc(l.phone)+'">\\u260E \\u05D4\\u05EA\\u05E7\\u05E9\\u05E8</a>';
              if(l.email)h+='<a href="mailto:'+esc(l.email)+'">\\u2709 \\u05DE\\u05D9\\u05D9\\u05DC</a>';
              if(l.phone)h+='<a href="https://wa.me/972'+esc(l.phone.replace(/^0/,'')).replace(/[^0-9]/g,'')+'\" target="_blank">WhatsApp</a>';
              if(l.trello_card_url)h+='<a href="'+esc(l.trello_card_url)+'\" target="_blank">Trello</a>';
              h+='</div>';
              h+='<div class="lead-actions">';
              var sts=[['new','\\u05D7\\u05D3\\u05E9'],['contacted','\\u05E0\\u05D9\\u05E6\\u05E8 \\u05E7\\u05E9\\u05E8'],['qualified','\\u05DE\\u05EA\\u05D0\\u05D9\\u05DD'],['negotiation','\\u05DE\\u05D5\\"\\u05DE'],['closed','\\u05E0\\u05E1\\u05D2\\u05E8'],['lost','\\u05D0\\u05D1\\u05D3']];
              for(var j=0;j<sts.length;j++){h+='<button class="lead-status-btn'+(l.status===sts[j][0]?' active-'+sts[j][0]:'')+'\" data-lead-update="'+l.id+'" data-new-status="'+sts[j][0]+'">'+sts[j][1]+'</button>';}
              h+='</div></div>';
            }}
            h+='</div>';return h;
          }
          function formatLeadDate(d){if(!d)return'';var dt=new Date(d),now=new Date(),diff=now-dt;if(diff<3600000)return Math.floor(diff/60000)+' \\u05D3\\u05E7\\u05D5\\u05EA';if(diff<86400000)return Math.floor(diff/3600000)+' \\u05E9\\u05E2\\u05D5\\u05EA';return dt.toLocaleDateString('he-IL');}
          function formatBudget(b){if(!b)return'';var m={'500k-1m':'500K-1M','1m-2m':'1-2M','2m-5m':'2-5M','5m+':'5M+','under-500k':'\\u05E2\\u05D3 500K'};return m[b]||b;}
          function esc(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
          """

          event_marker = "// ==================== EVENT DELEGATION ===================="
          content = content.replace(event_marker, render_leads + "\n" + event_marker)

          # Add lead event handlers
          old_actions = """  // Actions
            var ac=e.target.closest('[data-action]');
            if(ac){
              var a=ac.getAttribute('data-action');
              if(a==='ssi')runSSI();
              else if(a==='refresh'){loadData();if(LD)loadListings();}"""
          new_actions = """  // Lead filters
            var ltf=e.target.closest('[data-lead-type]');
            if(ltf){if(!filterStates.leads)filterStates.leads={};filterStates.leads.type=ltf.getAttribute('data-lead-type');renderTab();return;}
            var lsf=e.target.closest('[data-lead-status]');
            if(lsf){if(!filterStates.leads)filterStates.leads={};filterStates.leads.status=lsf.getAttribute('data-lead-status');renderTab();return;}
            var lsu=e.target.closest('[data-lead-update]');
            if(lsu){updateLeadStatus(lsu.getAttribute('data-lead-update'),lsu.getAttribute('data-new-status'));return;}
            // Actions
            var ac=e.target.closest('[data-action]');
            if(ac){
              var a=ac.getAttribute('data-action');
              if(a==='ssi')runSSI();
              else if(a==='refresh'){loadData();if(LD)loadListings();if(LEADS)loadLeads();}
              else if(a==='refresh-leads'){LEADS=null;loadLeads();}"""
          content = content.replace(old_actions, new_actions)

          with open('src/routes/dashboardRoutes.js', 'w') as f:
              f.write(content)
          print(f"Final: {len(content)} bytes")
          PYEOF
      - name: Commit and push
        run: |
          git config user.name "QUANTUM Bot"
          git config user.email "bot@u-r-quantum.com"
          git add src/routes/dashboardRoutes.js
          FILE_SIZE=$(wc -c < src/routes/dashboardRoutes.js)
          echo "File size: $FILE_SIZE bytes"
          git diff --cached --stat
          git commit -m "feat(dashboard): add leads management tab v4.26.0 - patch via Actions"
          git push